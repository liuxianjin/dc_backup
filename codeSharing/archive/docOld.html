<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,Chrome=1" />
    <title>大成围手术期云平台 V5.0-患者医疗文书</title>
    <link rel="stylesheet" type="text/css" href="/static/interface/surgery/request/css/documentBese.css" />
  </head>
  <body>
    <div style="text-align:center;clear:both"></div>
    <div id="menu">
      <div id="open">
        <div class="navBox">
          <ul class="navBoxUl"></ul>
        </div>
      </div>
      <div style="overflow: hidden;">
        <!--显示菜单-->
        <div id="pdfv" style="position: absolute;left: 260px;height:100%;width: 800px;overflow: hidden;">
          <iframe width="100%" height="100%" src="" frameborder="0"></iframe>
        </div>
      </div>
    </div>
    <script type="text/javascript" src="/static/interface/surgery/request/js/jquery-1.9.1.min.js"></script>
    <script>
      window.onload = function() {
        /* rem 适应*/
        /*让文字和标签的大小随着屏幕的尺寸做变话 等比缩放*/
        var html = document.getElementsByTagName("html")[0];
        /*取到屏幕的宽度*/
        var width = window.innerWidth;
        /* 640 100  320 50 */
        if (width > 1080) {
          width = 1080;
        } else if (width < 320) {
          width = 320;
        }
        var fontSize = (100 / 1080) * width;
        /*设置fontsize*/

        // html.style.fontSize = fontSize + 'px';
        window.onresize = function() {
          var html = document.getElementsByTagName("html")[0];
          /*取到屏幕的宽度*/
          var width = window.innerWidth;
          if (width > 1080) {
            width = 1080;
          } else if (width < 320) {
            width = 320;
          }
          /* 640 100  320 50 */
          var fontSize = (100 / 1080) * width;
          /*设置fontsize*/
          html.style.fontSize = fontSize + "px";
        };

        // https页面下将pdf静态资源url域名更换为当前页面域名
        var pageURL = window.location.href;
        var host = null;
        if (pageURL.substring(0, 5) == "https") {
          host = /^https:\/\/.*?\//.exec(pageURL)[0];
        }
        var flag = true;
        var SERVICE_URL = "/api/";
        var getParams = {
          admissionNumber: GetQueryString("admissionNum"),
          admissionTimes: GetQueryString("admissionTimes"),
          patientSyncId: GetQueryString("patientSyncId"),
          surgeryNoticeId: GetQueryString("surgeryNoticeId"),
          registerId: GetQueryString("registerId"),
          medicalRecordId: GetQueryString("medicalRecordId") || "", // TODO  温附一定制参数，定制参数后期需要挪出去
          menustyle: GetQueryString("menustyle") ? GetQueryString("menustyle") : "",
          isCustomizeFlow: GetQueryString("isCustomizeFlow")
        };
        // 主导航nav点击事件
        $.ajax({
          url: SERVICE_URL + "patient/document/patientdocurl",
          type: "get",
          dataType: "json",
          data: getParams,
          success: function(res) {
            if (getParams.menustyle == "light") {
              $(".navBox").addClass("light");
              $("#open").addClass("lightMenu");
            }
            var data = res.data;
            if (getParams.isCustomizeFlow) {
              if (data.length == 0) alert("该患者没有签名过的文书！");
              // 外部文书
              if (data.length > 0) {
                var height = data.length * 39;
                if (getParams.menustyle != "light") {
                  var dom = '<li><h2 class="obFocus">文书列表:</h2><div class="secondary" style="height:' + height + 'px;">';
                } else {
                  var dom = '<li><h2 class="obFocus" style="background-color:#fff;color:#282c3a">文书列表:</h2><div class="secondary " style="height:' + height + 'px;background-color:#fff;color:#282c3a">';
                }
                for (var p = 0; p < data.length; p++) {
                  if (getParams.menustyle != "light") {
                    dom += '<h3  class="obblack" data-sysno="' + data[p].sysno + '"">' + data[p].docname + "</h3>";
                  } else {
                    dom += '<h3 class="oblight" data-sysno="' + data[p].sysno + '">' + data[p].docname + "</h3>";
                  }
                }
                dom += "</div></li>";
                $(".navBoxUl").append(dom);
              }
            }else {
              // 内部文书
              if (data.length == 0) alert("该患者没有已归档的文书！");
              if (data.length > 0) {
                for (var i = 0; i < data.length; i++) {
                  if (i == 0) {
                    var height = data[i].item.length * 39;
                    if (getParams.menustyle != "light") {
                      var dom = '<li><h2 class="obFocus">手术日期:' + data[i].surgeryDate + '</h2><div class="secondary" style="height:' + height + 'px;">';
                    } else {
                      var dom = '<li><h2 class="obFocus"  style="background-color:#fff;color: #282c3a" >手术日期:' + data[i].surgeryDate + '</h2><div class="secondary" style="height:' + height + 'px;background-color:#fff;color:#282c3a">';
                    }
                    for (var p = 0; p < data[i].item.length; p++) {
                      if (host) data[i].item[p].url = data[i].item[p].url.replace(/^http:\/\/.*?\//, host);
                      dom += '<h3 data-url="' + data[i].item[p].url + '">' + data[i].item[p].name + "</h3>";
                    }
                    dom += "</div></li>";
                    $(".navBoxUl").append(dom);
                  } else {
                    var dom = '<li><h2 class="obtain">手术日期:' + data[i].surgeryDate + '</h2><div class="secondary">';
                    for (var p = 0; p < data[i].item.length; p++) {
                      if (host) data[i].item[p].url = data[i].item[p].url.replace(/^http:\/\/.*?\//, host);
                      if (getParams.menustyle != "light") {
                        dom += '<h3  class="obblack"  data-url="' + data[i].item[p].url + '">' + data[i].item[p].name + "</h3>";
                      } else {
                        dom += '<h3 class="oblight" data-url="' + data[i].item[p].url + '">' + data[i].item[p].name + "</h3>";
                      }
                    }
                    dom += "</div></li>";
                    $(".navBoxUl").append(dom);
                  }
                }
              }
            }

            var liC = document.querySelectorAll(".navBox li h2");
            for (var i = 0; i < liC.length; i++) {
              $(liC[i]).click(function() {
                if (flag) {
                  // 节流阀
                  flag = false;
                  setTimeout(function() {
                    flag = true;
                  }, 500);
                  // 自点
                  if (this.className === "obFocus") {
                    // this.querySelector("i").classList.remove("arrowRot");
                    getNext(this).style.height = "0";
                    // this.classList.add("obtain");
                    // this.classList.remove("obFocus");
                    $(this)
                      .addClass("obtain")
                      .removeClass("obFocus");
                    return;
                  }

                  var sec = getNext(this);
                  var sib = siblings(sec.parentNode);
                  var otherArr = [];
                  var arrowClass = [];
                  // 排他 secondary arrowRot obFocus
                  for (var j = 0; j < sib.length; j++) {
                    var sibSec = sib[j].getElementsByTagName("*");
                    for (var i = 0; i < sibSec.length; i++) {
                      if (sibSec[i].className == "secondary") {
                        otherArr.push(sibSec[i]);
                      }
                      // if (sibSec[i].className == "arrowRot") {
                      //     arrowClass.push(sibSec[i])
                      // }
                      if (sibSec[i].className == "obFocus") {
                        // sibSec[i].classList.remove("obFocus");
                        // sibSec[i].classList.add("obtain");
                        $(sibSec[i])
                          .addClass("obtain")
                          .removeClass("obFocus");
                      }
                    }
                  }
                  for (var i = 0; i < otherArr.length; i++) {
                    otherArr[i].style.height = "0";
                  }
                  if (arrowClass[0]) {
                    // arrowClass[0].classList.remove("arrowRot");
                  }

                  // 留自己
                  sec.style.height = sec.children.length * 39 + "px";
                  // this.getElementsByTagName("i")[0].classList.add("arrowRot");
                  // this.classList.remove("obtain");
                  // this.classList.add("obFocus");

                  $(this)
                    .addClass("obFocus")
                    .removeClass("obtain");
                }
              });
              // 初始化展示第一个
              if (getParams.isCustomizeFlow && data.length > 0) {
                showPdf(data[0].sysno);
              } else if (data.length > 0 && data[0].item.length > 0) {
                loadIframe(data[0].item[0].url);
              }
              var seconC = document.querySelectorAll(".secondary h3");
              $(seconC[0]) && $(seconC[0]).addClass("seconFocus");
              $("#pdfv").width($(window).width() - 260);
            }
            // 子导航点击事件
            var seconC = document.querySelectorAll(".secondary h3");
            for (var i = 0; i < seconC.length; i++) {
              $(seconC[i]).click(function() {
                for (var i = 0; i < seconC.length; i++) {
                  $(seconC[i]).removeClass("seconFocus");
                }
                // 外部
                if (getParams.isCustomizeFlow) {
                  showPdf(this.getAttribute("data-sysno"))
                }else {
                  loadIframe(this.getAttribute("data-url"));
                }
                $(this).addClass("seconFocus");
              });
            }
          }
        });
      };
      function loadIframe(src) {
        // 跨域访问处理
        if(src.indexOf('blob:') === -1){
          let str = src.split('//')[1];
          str = str.substring(str.indexOf("/"));
          src = window.location.origin + str
        }
        if (isIE()) {
          $("#pdfv").html('<iframe width="100%" height="100%" src="/static/pdfjs/web/viewer.html?file=' + src + ' " frameborder="0"></iframe>');
        } else {
          $("#pdfv").html('<iframe id="pdfv" type="application/pdf" src="' + src + '" width="100%" height="100%" frameborder="0">');
        }
      }

      function showPdf(sysno){
        $.ajax({
          url: "/api/patient/patient/signature/pdf/base64",
          type: "get",
          dataType: "json",
          data: {
            signSyncId: sysno,
            documentId: sysno
          },
          success: function(data) {
            if (data.success == true) {
              var base = data.data.signResultPdfBase64;
              var blob = base64ToBlob(base);
              var src = URL.createObjectURL(blob);
              loadIframe(src);
            }
          }
        });
      }

      function isIE() {
        return !!window.ActiveXObject || "ActiveXObject" in window;
      }
      function base64ToBlob(code) {
        code = code.replace(/[\n\r]/g, "");
        var raw = window.atob(code);
        var rawLength = raw.length;
        var uint8Array = new Uint8Array(rawLength);
        for (let i = 0; i < rawLength; i++) {
          uint8Array[i] = raw.charCodeAt(i);
        }
        return new Blob([uint8Array], { type: "application/pdf" });
      }
      function GetQueryString(name) {
        var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
        var r = window.location.search.substr(1).match(reg); //获取url中"?"符后的字符串并正则匹配
        var context = "";
        if (r != null) context = r[2];
        reg = null;
        r = null;
        return context == null || context == "" || context == "undefined" ? "" : context;
      }
      function getByClass(clsName, parent) {
        var oParent = parent ? document.getElementById(parent) : document,
          boxArr = new Array(),
          oElements = oParent.getElementsByTagName("*");
        for (var i = 0; i < oElements.length; i++) {
          if (oElements[i].className == clsName) {
            boxArr.push(oElements[i]);
          }
        }
        return boxArr;
      }
      // 获取下一个兄弟元素
      function getNext(node) {
        if (!node.nextSibling) return null;
        var nextNode = node.nextSibling;
        if (nextNode.nodeType == 1) {
          return nextNode;
        }
        return getNext(node.nextSibling);
      }

      // 获取除了自己以外的其他亲兄弟元素
      function siblings(elem) {
        var r = [];
        var n = elem.parentNode.firstChild;
        for (; n; n = n.nextSibling) {
          if (n.nodeType === 1 && n !== elem) {
            r.push(n);
          }
        }
        return r;
      }
    </script>
  </body>
</html>
